
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * KONNEX SECURITY RULES
     * 
     * Core Philosophy:
     * Identity-based authorization enforcing privacy for profiles while allowing 
     * public access to job listings and shared access to applications.
     */

    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    function isDataOwner(ownerIdField) {
      return isSignedIn() && request.auth.uid == ownerIdField;
    }

    // ==========================================
    // COLLECTION RULES
    // ==========================================

    /**
     * @description Rules for job seeker profiles. Accessible only by the job seeker themselves.
     * @path /jobseekerProfile/{jobseekerId}
     */
    match /jobseekerProfile/{jobseekerId} {
      allow get, list: if isOwner(jobseekerId);
      allow create: if isOwner(jobseekerId) && request.resource.data.id == jobseekerId;
      allow update: if isExistingOwner(jobseekerId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(jobseekerId);
    }

    /**
     * @description Rules for employer profiles. Accessible only by the employer themselves.
     * @path /employerProfiles/{employerId}
     */
    match /employerProfiles/{employerId} {
      allow get, list: if isOwner(employerId);
      allow create: if isOwner(employerId) && request.resource.data.id == employerId;
      allow update: if isExistingOwner(employerId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(employerId);
    }

    /**
     * @description Job listings are public to all signed-in users but only editable by the posting employer.
     */
    match /jobListings/{jobListingId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.employerId == request.auth.uid;
      allow update: if resource != null && isDataOwner(resource.data.employerId) && request.resource.data.employerId == resource.data.employerId;
      allow delete: if resource != null && isDataOwner(resource.data.employerId);
    }

    /**
     * @description Applications connect job seekers and employers.
     */
    match /applications/{applicationId} {
      allow get: if isSignedIn() && (isDataOwner(resource.data.studentId) || isDataOwner(resource.data.employerId));
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update: if resource != null && (isDataOwner(resource.data.studentId) || isDataOwner(resource.data.employerId)) && request.resource.data.studentId == resource.data.studentId && request.resource.data.employerId == resource.data.employerId;
      allow delete: if resource != null && (isDataOwner(resource.data.studentId) || isDataOwner(resource.data.employerId));
    }
  }
}
